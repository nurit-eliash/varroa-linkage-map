---
title: "lep-MAP3-varroa"
author: "Nurit Eliash"
date: '2022-07-05'
output:
  html_document:
    code_folding: hide
    theme: cerulean
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: yes
      df_print: paged
---
<style type="text/css">
  body{
  font-size: 12pt;
}
</style>

# AIM: Constructing a linkage map for male and female varroa mites

## Load libraries
```{r setup, include=FALSE, warning=FALSE}
library("tidyverse")
library("plyr")
library("dplyr")
library("ggplot2")
library("scales")
library("ggpubr")
library("gridExtra") # for arranging a few plots in one area
#library("grid")
#library("GGally")
library("data.table")
library("stringr")
library("janitor")
library("plotly") # to identify outliers. 
library("readr") # to extract numbers from a vector
library("tidyr")
library("LinkageMapView") # for constructing the linkage map

knitr::opts_chunk$set(echo = TRUE)
```

19/10/22
lepmap using only informative sites (0/0 x 0/1) , assuming 1 family
/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_00_01/Recom_male_fem

lepmap using only informative sites (1/1 x 0/1) , assuming 1 family
/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_11_01/Recom_male_fem

**Does the markers' physical position correlates to its genetic position, as determined by recombination rate?**  

# 0/0 x 0/1 cross

## Assuming recombintaions in males and females
```{r echo=FALSE, warning=FALSE,message=FALSE}
setwd("/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_00_01/Recom_male_fem")

# get a vector of the input files ('order_.mapped' files in the directory)
map_files = list.files(path ="/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_00_01/Recom_male_fem", pattern = "\\mapped$", full.names = T)

# set a list to put the plots in
out_plotSites = list()

# set a list to put the positions in, for later linkage mapping
out_Sites = list()

for (i in map_files)  {
  mapped <- read.table(i,  header =FALSE, sep ="\t")[,1:4]
  names(mapped) = c("Chr","POS","male_position", "female_position")
  mapped <- dplyr::mutate(mapped, LG =  basename(i) %>%  readr::parse_number() %>% as.character())

# calculate the total genetic size per LG
sizeFem <- unique(mapped$female_position) %>% sum()
sizeMale <- unique(mapped$male_position) %>% sum()

df <- mapped %>% pivot_longer(cols = c(male_position,female_position), names_to = "sex", values_to = "cM") 

p_site <- ggplot(df, aes(x=POS, y=cM)) +
  geom_point() +stat_cor(method = "pearson") + geom_smooth(method='lm') +
  ylab("Genetic position (cM)") +
  xlab("Physical position") + labs(title = paste0("LG: ", mapped[1,5],", Chromosome: ", mapped[1,1]), subtitle =  paste0("total size (cM): female = ", sizeFem, "; male: ",sizeMale)) +
facet_wrap("sex")

out_plotSites[[i]] = p_site
out_Sites[[i]] = df
 } 

# plot all LGs, by sex (i split into 2 plots, caus its too big)
#grid.arrange(top= grid::textGrob("Physical and genetic position correlation, assuming recombintaion in both sex", gp=grid::gpar(fontsize=24)), out_plotSites$order_1.mapped,out_plotSites$order_2.mapped, out_plotSites$order_3.mapped,out_plotSites$order_4.mapped, out_plotSites$order_5.mapped, out_plotSites$order_6.mapped, out_plotSites$order_7.mapped) 

# combine all LGs
sites_recom <-  reduce(out_Sites, bind_rows)  %>% distinct() %>% as.data.frame()

#save the markers positions 
#write.table(sites_recom,"/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/results/00_01_cross/sites_recom.csv", col.names=T)
```

## Assuming recombinations in *FEMALES ONLY*
```{r echo=FALSE, warning=FALSE,message=FALSE}
setwd("/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_00_01/0_male")

# get a vector of the input files ('order_.mapped' files in the directory)
map_files = list.files(path ="/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_00_01/0_male", pattern = "\\mapped$", full.names = TRUE)

# set a list to put the plots in
out_plotSites = list()

# set a list to put the positions in, for later linkage mapping
out_Sites = list()

for (i in map_files) {
  mapped <- read.table(i,  header =FALSE, sep ="\t")[,1:4]
  names(mapped) = c("Chr","POS","male_position", "female_position")
  mapped <- dplyr::mutate(mapped, LG =  basename(i) %>%  readr::parse_number() %>% as.character())

# calculate the total genetic size per LG
sizeFem <- unique(mapped$female_position) %>% sum()
sizeMale <- unique(mapped$male_position) %>% sum()

df <- mapped %>% pivot_longer(cols = c(male_position,female_position), names_to = "sex", values_to = "cM") 

p_site <- ggplot(df, aes(x=POS, y=cM)) +
  geom_point() +stat_cor(method = "pearson") + geom_smooth(method='lm') +
  ylab("Genetic position (cM)") +
  xlab("Physical position") + labs(title = paste0("LG: ", mapped[1,5],", Chromosome: ", mapped[1,1]), subtitle =  paste0("total size (cM): female = ", sizeFem, "; male: ",sizeMale)) +
facet_wrap("sex")

out_plotSites[[i]] = p_site
out_Sites[[i]] = df
 }

# plot all LGs, by sex
#grid.arrange(top= grid::textGrob("Physical and genetic position correlation, assuming recombintaion only in FEMALES", gp=grid::gpar(fontsize=24)),  out_plotSites$order_1.mapped,out_plotSites$order_2.mapped, out_plotSites$order_3.mapped,out_plotSites$order_4.mapped, out_plotSites$order_5.mapped, out_plotSites$order_6.mapped, out_plotSites$order_7.mapped) 

# combine all LGs
sites_0male <-  reduce(out_Sites, bind_rows)  %>% distinct() %>% as.data.frame()

#save the markers positions 
#write.table(sites_0male,"/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/results/00_01_cross/sites_0male.csv", col.names=T)
```

## Assuming recombintaions in *MALES only*
```{r echo=FALSE, warning=FALSE,message=FALSE}
setwd("/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_00_01/0_fem")

# get a vector of the input files ('order_.mapped' files in the directory)
map_files = list.files(path ="/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_00_01/0_fem", pattern = "\\mapped$", full.names = TRUE)

# set a list to put the plots in
out_plotSites = list()

# set a list to put the positions in, for later linkage mapping
out_Sites = list()

for (i in map_files) {
  mapped <- read.table(i,  header =FALSE, sep ="\t")[,1:4]
  names(mapped) = c("Chr","POS","male_position", "female_position")
  mapped <- dplyr::mutate(mapped, LG =  basename(i) %>%  readr::parse_number() %>% as.character())

# calculate the total genetic size per LG
sizeFem <- unique(mapped$female_position) %>% sum()
sizeMale <- unique(mapped$male_position) %>% sum()

df <- mapped %>% pivot_longer(cols = c(male_position,female_position), names_to = "sex", values_to = "cM") 

p_site <- ggplot(df, aes(x=POS, y=cM)) +
  geom_point() +stat_cor(method = "pearson") + geom_smooth(method='lm') +
  ylab("Genetic position (cM)") +
  xlab("Physical position") + labs(title = paste0("LG: ", mapped[1,5],", Chromosome: ", mapped[1,1]), subtitle =  paste0("total size (cM): female = ", sizeFem, "; male: ",sizeMale)) +
facet_wrap("sex")

out_plotSites[[i]] = p_site
out_Sites[[i]] = df
 }

# plot all LGs, by sex
#grid.arrange(top= grid::textGrob("Physical and genetic position correlation, assuming recombintaion only in MALES", gp=grid::gpar(fontsize=24)),  out_plotSites$order_1.mapped,out_plotSites$order_2.mapped, out_plotSites$order_3.mapped,out_plotSites$order_4.mapped, out_plotSites$order_5.mapped, out_plotSites$order_6.mapped, out_plotSites$order_7.mapped) 

# combine all LGs
sites_0fem <-  reduce(out_Sites, bind_rows)  %>% distinct() %>% as.data.frame()
#save the markers positions 
#write.table(sites_0fem,"/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/results/00_01_cross/sites_0fem.csv", col.names=T)
```

# 1/1 x 0/1 cross

## Assuming recombintaions in males and females
```{r echo=FALSE, warning=FALSE,message=FALSE}
setwd("/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_11_01/Recom_male_fem")

# get a vector of the input files ('order_.mapped' files in the directory)
map_files = list.files(path ="/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_11_01/Recom_male_fem", pattern = "\\mapped$", full.names = TRUE)

# set a list to put the plots in
out_plotSites = list()

# set a list to put the positions in, for later linkage mapping
out_Sites = list()

for (i in map_files) {
  mapped <- read.table(i,  header =FALSE, sep ="\t")[,1:4]
  names(mapped) = c("Chr","POS","male_position", "female_position")
  mapped <- dplyr::mutate(mapped, LG =  basename(i) %>%  readr::parse_number() %>% as.character())

# calculate the total genetic size per LG
sizeFem <- unique(mapped$female_position) %>% sum()
sizeMale <- unique(mapped$male_position) %>% sum()

df <- mapped %>% pivot_longer(cols = c(male_position,female_position), names_to = "sex", values_to = "cM") 

p_site <- ggplot(df, aes(x=POS, y=cM)) +
  geom_point() +stat_cor(method = "pearson") + geom_smooth(method='lm') +
  ylab("Genetic position (cM)") +
  xlab("Physical position") + labs(title = paste0("LG: ", mapped[1,5],", Chromosome: ", mapped[1,1]), subtitle =  paste0("total size (cM): female = ", sizeFem, "; male: ",sizeMale)) +
facet_wrap("sex")

out_plotSites[[i]] = p_site
out_Sites[[i]] = df
 }

# plot all LGs, by sex (i split into 2 plots, caus its too big)
#grid.arrange(top= grid::textGrob("Physical and genetic position correlation, assuming recombintaion in both sex", gp=grid::gpar(fontsize=24)), out_plotSites$order_1.mapped,out_plotSites$order_2.mapped, out_plotSites$order_3.mapped,out_plotSites$order_4.mapped, out_plotSites$order_5.mapped, out_plotSites$order_6.mapped, out_plotSites$order_7.mapped) 

# combine all LGs
sites_recom <-  reduce(out_Sites, bind_rows)  %>% distinct() %>% as.data.frame()

#save the markers positions 
#write.table(sites_recom,"/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/results/11_01_cross/sites_recom.csv", col.names=T)
```

## Assuming recombinations in *FEMALES ONLY*
```{r echo=FALSE, warning=FALSE,message=FALSE}
setwd("/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_11_01/0_male")

# get a vector of the input files ('order_.mapped' files in the directory)
map_files = list.files(path ="/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_11_01/0_male", pattern = "\\mapped$", full.names = TRUE)

# set a list to put the plots in
out_plotSites = list()

# set a list to put the positions in, for later linkage mapping
out_Sites = list()

for (i in map_files) {
  mapped <- read.table(i,  header =FALSE, sep ="\t")[,1:4]
  names(mapped) = c("Chr","POS","male_position", "female_position")
  mapped <- dplyr::mutate(mapped, LG =  basename(i) %>%  readr::parse_number() %>% as.character())

# calculate the total genetic size per LG
sizeFem <- unique(mapped$female_position) %>% sum()
sizeMale <- unique(mapped$male_position) %>% sum()

df <- mapped %>% pivot_longer(cols = c(male_position,female_position), names_to = "sex", values_to = "cM") 

p_site <- ggplot(df, aes(x=POS, y=cM)) +
  geom_point() +stat_cor(method = "pearson") + geom_smooth(method='lm') +
  ylab("Genetic position (cM)") +
  xlab("Physical position") + labs(title = paste0("LG: ", mapped[1,5],", Chromosome: ", mapped[1,1]), subtitle =  paste0("total size (cM): female = ", sizeFem, "; male: ",sizeMale)) +
facet_wrap("sex")

out_plotSites[[i]] = p_site
out_Sites[[i]] = df
 }

# plot all LGs, by sex
#grid.arrange(top= grid::textGrob("Physical and genetic position correlation, assuming recombintaion only in FEMALES", gp=grid::gpar(fontsize=24)),  out_plotSites$order_1.mapped,out_plotSites$order_2.mapped, out_plotSites$order_3.mapped,out_plotSites$order_4.mapped, out_plotSites$order_5.mapped, out_plotSites$order_6.mapped, out_plotSites$order_7.mapped) 

# combine all LGs
sites_0male <-  reduce(out_Sites, bind_rows)  %>% distinct() %>% as.data.frame()

#save the markers positions 
#write.table(sites_0male,"/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/results/11_01_cross/sites_0male.csv", col.names=T)
```

## Assuming recombintaions in *MALES only*
```{r echo=FALSE, warning=FALSE,message=FALSE}
setwd("/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_11_01/0_fem")

# get a vector of the input files ('order_.mapped' files in the directory)
map_files = list.files(path ="/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/data/Q40BIALLDP16HDP40mis.5Chr7.infoSites/Q40BIALLDP16HDP40mis.5Chr7.Sites_11_01/0_fem", pattern = "\\mapped$", full.names = TRUE)

# set a list to put the plots in
out_plotSites = list()

# set a list to put the positions in, for later linkage mapping
out_Sites = list()

for (i in map_files) {
  mapped <- read.table(i,  header =FALSE, sep ="\t")[,1:4]
  names(mapped) = c("Chr","POS","male_position", "female_position")
  mapped <- dplyr::mutate(mapped, LG =  basename(i) %>%  readr::parse_number() %>% as.character())

# calculate the total genetic size per LG
sizeFem <- unique(mapped$female_position) %>% sum()
sizeMale <- unique(mapped$male_position) %>% sum()

df <- mapped %>% pivot_longer(cols = c(male_position,female_position), names_to = "sex", values_to = "cM") 

p_site <- ggplot(df, aes(x=POS, y=cM)) +
  geom_point() +stat_cor(method = "pearson") + geom_smooth(method='lm') +
  ylab("Genetic position (cM)") +
  xlab("Physical position") + labs(title = paste0("LG: ", mapped[1,5],", Chromosome: ", mapped[1,1]), subtitle =  paste0("total size (cM): female = ", sizeFem, "; male: ",sizeMale)) +
facet_wrap("sex")

out_plotSites[[i]] = p_site
out_Sites[[i]] = df
 }

# plot all LGs, by sex
#grid.arrange(top= grid::textGrob("Physical and genetic position correlation, assuming recombintaion only in MALES", gp=grid::gpar(fontsize=24)),  out_plotSites$order_1.mapped,out_plotSites$order_2.mapped, out_plotSites$order_3.mapped,out_plotSites$order_4.mapped, out_plotSites$order_5.mapped, out_plotSites$order_6.mapped, out_plotSites$order_7.mapped) 

# combine all LGs
sites_0fem <-  reduce(out_Sites, bind_rows)  %>% distinct() %>% as.data.frame()
#save the markers positions 
#write.table(sites_0fem,"/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/results/11_01_cross/sites_0fem.csv", col.names=T)
```

## Genetic map based on 00 x 01 cross

The genetic maps are based on two different crosses: 
 - 0/0 x 0/1
 - 1/1 x 0/1
 
the position of the markers are based on recombination frequency (done by Lep-MAP OrderMarkrs2 module)
code in  ~/Documents/GitHub/varroa-linkage-map/varroa_lepmap/script/lep-MAP3-varroa.Rmd

### Markers positions, assuming recombinations in *both sexes*
```{r}
#load data of the markers position 
sites_recom = read.csv(file = "/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/varroa_lepmap/results/00_01_cross/sites_recom.csv", header = TRUE, sep = " ")
# ~/Documents/GitHub/varroa-linkage-map/varroa_lepmap/script/lep-MAP3-varroa.Rmd

# change the names of the columns, so it will fit for the lmv command:
#>     group position    locus
#> 1 2170LG3    0.000 BSSR-094
#> 2 2170LG3    7.039   ESSR86
#> 3 2170LG3   11.123      F3H
#> 4 2170LG3   11.123     FLS1

#"group" is the LG (1-7) + add the sex
# "position" is the genetic position (cM on the LG)
# "locus" is the physical position (Chr_pos)

sites_recom_map <- sites_recom %>% dplyr::select(c(group=LG, position = cM, locus = POS, sex = sex))
head(sites_recom_map)

## Female positions, assuming recombination in both sexes ###
cM_Recom_femPOS <- sites_recom_map %>% filter(sex=="female_position") %>% select(-sex)
head(cM_Recom_femPOS)

#outfile = file.path("/Users/nuriteliash/Desktop", "cM_Recom_femPOS.pdf")
#lmv.linkage.plot(mapthis = cM_Recom_femPOS, outfile = outfile, main="Female positions, assuming recombination in both sexes",col.main = "red")

# density map: denmap=TRUE
outfile = file.path("/Users/nuriteliash/Desktop", "cM_Recom_femPOS_dens_00_01.pdf")
lmv.linkage.plot(mapthis = cM_Recom_femPOS, outfile = outfile, main="Female positions, based on 0/0 x 0/1 cross, assuming recombination in both sexes",col.main = "red", denmap=TRUE)

## Male positions, assuming recombination in both sexes
cM_Recom_malePOS <- sites_recom_map %>% filter(sex=="male_position") %>% select(-sex)
head(cM_Recom_malePOS)
  
#outfile = file.path("/Users/nuriteliash/Desktop", "cM_Recom_malePOS.pdf")
#lmv.linkage.plot(mapthis = cM_Recom_malePOS, outfile = outfile, main="Male positions, assuming recombination in both sexes",col.main = "blue")

# density map: denmap=TRUE
outfile = file.path("/Users/nuriteliash/Desktop", "cM_Recom_malePOS_dens_00_01.pdf")
lmv.linkage.plot(mapthis = cM_Recom_malePOS, outfile = outfile, main="Male positions, based on 0/0 x 0/1 cross, assuming recombination in both sexes",col.main = "blue", denmap=TRUE)
```