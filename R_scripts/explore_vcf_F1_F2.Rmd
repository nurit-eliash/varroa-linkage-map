---
title: "explore_vcf_F1_F2"
author: "Nurit Eliash"
date: "1/24/2022"
output: html_document
---

## Is the mode of inheritance differ between males and females? (in the 2 generations: 
F1 (son and daughter) -> F2 (grandson and granddaughter) 
compare proportion of site zygocity 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### load libraries
```{r}
library("tidyverse")
library("dplyr")
library("ggplot2")
library("ggpubr")
library("scales")
library("ggpubr")
library("gridExtra")
library("grid")
library("GGally")
library("vcfR")
library("data.table")
library("stringr")
library("janitor")
library("gmodels")
library(plyr)
```

load five families with at least one grandson and two granddaughters: 
240, 284, 502, 498, 476
in total 40 individuals
```{r}
vcf <- read.vcfR("/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/data/vcf_filter/five_fam.Q40BIALLDP16HDP40mis.5Chr7/five_fam.Q40BIALLDP16HDP40mis.5Chr7.recode.vcf", verbose = FALSE )
vcf

# extract the genotype for each site in each individual
gt <- extract.gt(vcf, element = "GT") 

gt <- as.data.frame(t(gt)) %>%
  rownames_to_column("sample")
# add additional info for each individual
gt_info <- gt %>%
  mutate(fam = str_extract(sample, "[^_]+")) %>%
  mutate(sex = case_when(
    grepl("son", sample) ~ "male",
    grepl("dat|fnd|sis", sample) ~ "female",
    grepl( "_grn_",sample) ~ "ND")) %>%
  mutate(generation = case_when(
    grepl("fnd", sample) ~ "F0",
    grepl("_dat_|sis|_son_", sample) ~ "F1",
    grepl("grn", sample) ~ "F2")) %>%
  mutate(fam_membership = case_when(
    grepl("fnd", sample) ~ "Foundress_mother",
    grepl("_dat_", sample) ~ "Daughter",
    grepl("sis", sample) ~ "Second_daughter",
    grepl("_son_", sample) ~ "Son",
    grepl("grnson", sample) ~ "Grandson",
    grepl("_grndat_", sample) ~ "Granddaughter",
    grepl("_grn_", sample) ~ "Grandson_daughter")) %>%
  dplyr::select(sample, fam, sex, generation, fam_membership, everything())
# t() %>%
#as.data.frame() %>%
#row_to_names(row_number = 1)
```


# analyse family 240 
```{r}
gt_240 <- gt_info %>%
  filter((fam == "240")) %>%
  dplyr::select(-c(sex, generation, fam_membership)) %>%
  t() %>%
as.data.frame() %>%
row_to_names(row_number = 1)

# change the sample name to a general name:
colnames(gt_240)[grepl('fnd',colnames(gt_240))] <- 'fnd'
colnames(gt_240)[grepl('_son_',colnames(gt_240))] <- 'son'
colnames(gt_240)[grepl('_grnson',colnames(gt_240))] <- 'grnson'
colnames(gt_240)[grepl('_dat',colnames(gt_240))] <- 'dat'
colnames(gt_240)[grepl('_sis',colnames(gt_240))] <- 'sis'
colnames(gt_240)[grepl('a_grndat',colnames(gt_240))] <- 'grndat_1'
colnames(gt_240)[grepl('b_grndat',colnames(gt_240))] <- 'grndat_2'
colnames(gt_240)[grepl('d_grn',colnames(gt_240))] <- 'grn_3'
colnames(gt_240)[grepl('e_grn',colnames(gt_240))] <- 'grn_4'

# first make a count table with the 3 genotypes for each sample 
# (1) extract the sites that are homozygotic 0/0 in the son (F1) mite
F1_son_0.0 <- gt_240 %>%
  dplyr::filter(grepl("0/0", son))

# (2) extract the sites that are homozygotic 1/1 in the son (F1) mite
F1_son_1.1 <- gt_240 %>%
  dplyr::filter(grepl("1/1", son))

# (3) extract the sites that are hetero 0/1 in the son (F1) mite
F1_son_0.1 <- gt_240 %>%
  dplyr::filter(grepl("0/1", son))
```

## crossing 0/0 male with 0/1 female
```{r}
# of the homozygotic sites (0/0), pick the ones that have heterozygotic (0/1) genotype in the daughter (his wife, F1):
F1_son_0.0_dat_0.1 <- F1_son_0.0 %>%
  dplyr::filter(grepl("0/1", dat))
# only 131 sites are left

# what is the genotype of their offsprings? (F2)  
grnson <- F1_son_0.0_dat_0.1 %>%
  dplyr::count(grnson) %>% 
  na.omit() %>%
  pivot_longer(cols = starts_with("grn"),  
               names_to = "F2", 
               values_to = "Gt")
grndat_1 <- F1_son_0.0_dat_0.1 %>%
  dplyr::count(grndat_1) %>% 
  na.omit() %>%
  pivot_longer(cols = starts_with("grn"),  
               names_to = "F2", 
               values_to = "Gt")
grndat_2 <- F1_son_0.0_dat_0.1 %>%
  dplyr::count(grndat_2) %>% 
  na.omit() %>%
  pivot_longer(cols = starts_with("grn"),  
               names_to = "F2", 
               values_to = "Gt")
grn_3 <- F1_son_0.0_dat_0.1 %>%
  dplyr::count(grn_3) %>% 
  na.omit() %>%
  pivot_longer(cols = starts_with("grn"),  
               names_to = "F2", 
               values_to = "Gt")
grn_4 <- F1_son_0.0_dat_0.1 %>%
  dplyr::count(grn_4) %>% 
  na.omit() %>%
  pivot_longer(cols = starts_with("grn"),  
               names_to = "F2", 
               values_to = "Gt")
count_F2 <- bind_rows(grnson,grndat_1,grndat_2,grn_3,grn_4)

prop <- count_F2 %>%
  pivot_wider(names_from = Gt, values_from = n) %>%
  mutate(total = `0/0` + `0/1`) 

# try to understand how is the 'estimate' is calculated in the prop.test function
grnson_CI <- prop.test(prop$`0/0`[1], prop$total[1])
prop.test(prop$`0/0`[2], prop$total[2])
prop.test(prop$`0/0`[3], prop$total[3])
prop.test(prop$`0/0`[4], prop$total[4])
prop.test(prop$`0/0`[5], prop$total[5])

low_IC <- grnson_CI$conf.int[1]
high_IC <- grnson_CI$conf.int[2]

# אני מנסה להכניס אוטומטית את הערכים של רווח בר סמך לגרף
# maybe something like this
#https://stackoverflow.com/questions/57342086/working-with-tidyverse-ggplot-and-broom-to-add-confidence-interval-to-a-propor

mutate(tst = list(broom::tidy(prop.test(prop$`0/0`[1], prop$total[1], conf.level=0.95)))) %>%
  tidyr::unnest(tst)

tst[["parameters"]]
  
ggplot(count_F2, aes(y=n, x=F2, color=Gt)) + 
    geom_point(size = 4) +
    geom_errorbar(aes(ymin=grnson_CI$conf.int[1], ymax=grnson_CI$conf.int[2])) +
    xlab("F2 siblings") + 
    ylab("Proportion of F2 genotype") +
    labs(title = "F2 genotype of F1 cross: son (0/1) x daughter (0/0), 
family 240")  
   #geom_text(aes(label = n), position = position_fill(vjust = 0.2, reverse= F))
#sasha:
# calculate mean for each individual. So instead of the bar plot, you do a point interval plot. It’s a way of showing uncertainty due to sampling
# compute confidence intervals for proportions

#plot it
p_son_0.0_dat_0.1 <- ggplot(count_F2, aes(fill=Gt, y=n, x=F2)) + 
    geom_bar(position="fill", stat="identity") +
    xlab("F2 siblings") + 
    ylab("Proportion of F2 genotype") +
    labs(title = "F2 genotype of F1 cross: son (0/0) x daughter (0/1), 
family 240") + 
   geom_text(aes(label = n), position = position_fill(vjust = 0.2, reverse= F))

# none of the F2 have 1/1 genotype, as expected
# male and female offspring behave the same
```

## crossing 0/1 male with 0/0 female
```{r}
# of the heterozygotic sites (0/1), pick the ones that have homozygotic (0/0) genotype in the dauther (his sister, F1):
F1_son_0.1_dat_0.0 <- F1_son_0.1 %>%
  dplyr::filter(grepl("0/0", dat))
# only 267 sites are left

# what is the genotype of their offsprings? (F2)  
grnson <- F1_son_0.1_dat_0.0 %>%
  dplyr::count(grnson) %>% 
  na.omit() %>%
  pivot_longer(cols = starts_with("grn"),  
               names_to = "F2", 
               values_to = "Gt")
grndat_1 <- F1_son_0.1_dat_0.0 %>%
  dplyr::count(grndat_1) %>% 
  na.omit() %>%
  pivot_longer(cols = starts_with("grn"),  
               names_to = "F2", 
               values_to = "Gt")
grndat_2 <- F1_son_0.1_dat_0.0 %>%
  dplyr::count(grndat_2) %>% 
  na.omit() %>%
  pivot_longer(cols = starts_with("grn"),  
               names_to = "F2", 
               values_to = "Gt")
grn_3 <- F1_son_0.1_dat_0.0 %>%
  dplyr::count(grn_3) %>% 
  na.omit() %>%
  pivot_longer(cols = starts_with("grn"),  
               names_to = "F2", 
               values_to = "Gt")
grn_4 <- F1_son_0.1_dat_0.0 %>%
  dplyr::count(grn_4) %>% 
  na.omit() %>%
  pivot_longer(cols = starts_with("grn"),  
               names_to = "F2", 
               values_to = "Gt")
count_F2 <- bind_rows(grnson,grndat_1,grndat_2,grn_3,grn_4)
#plot it
p_son_0.1_dat_0.0 <- ggplot(count_F2, aes(fill=Gt, y=n, x=F2)) + 
    geom_bar(position="fill", stat="identity") +
    xlab("F2 siblings") + 
    ylab("Proportion of F2 genotype") +
    labs(title = "F2 genotype of F1 cross: son (0/1) x daughter (0/0), 
family 240") + 
   geom_text(aes(label = n), position = position_fill(vjust = 0.2, reverse= F))

# a few of the F2 females have 1/1 genotype, not as expected! but not in the male grnson
```

23/3/2022
another option: 
Try the R prop.test function to compute confidence intervals for proportions
You can ignore impossible genotypes for this purpose
each dot is site , and the mean is calculated per individual
It’s a way of showing uncertainty due to sampling

** for that, i need to use the original table of F1_son_0.1_dat_0.0, 
```{r}
#try to make in here the right table in order to show each site Gt in each  F2 individual
#df <- F1_son_0.1_dat_0.0 %>%
  rownames_to_column("site")

 ggplot(df, aes(y=n, x=F2, color=Gt)) + 
    geom_point(size = 6) +
    xlab("F2 siblings") + 
    ylab("Proportion of F2 genotype") +
    labs(title = "F2 genotype of F1 cross: son (0/1) x daughter (0/0), 
family 240") + 
   geom_text(aes(label = n), position = position_fill(vjust = 0.2, reverse= F))
```

```{r}
#plot them together
ggarrange(p_son_0.1_dat_0.0,p_son_0.0_dat_0.1,
          ncol = 2, nrow = 1)

 prop.test 
 
 
 #old stack plot
 
```

```{r}
---------
# (1) of the homozygotic 
#how many of the son's sites are homozygotic as the mom (0/0)? --> expected from haplo-diplo inheritance mode
F0_0.0F1son_0.0 <- F0_0.0 %>%
  dplyr::filter(grepl("0/0", son))  
# how many of the sites are heterozygotic? 0/1--> expected from diplo inheritance mode
F0_0.0F1son_0.1 <- F0_0.0 %>%
  dplyr::filter(grepl("0/1", son))
# how many of the sites are homozygotic 1/1? --> impossible (mistake) 
F0_0.0F1son_1.1 <- F0_0.0 %>%
  dplyr::filter(grepl("1/1", son))
###############################

# (2) how does the son's site behave in alternative homo mom? 1/1
F0_1.1F1son_0.0 <- F0_1.1 %>%
  dplyr::filter(grepl("0/0", son))  
F0_1.1F1son_0.1 <- F0_1.1 %>%
  dplyr::filter(grepl("0/1", son))
F0_1.1F1son_1.1 <- F0_1.1 %>%
  dplyr::filter(grepl("1/1", son))

# (3) how does the son's site behave in hetero mom? 0/1
F0_0.1F1son_0.0 <- F0_0.1 %>%
  dplyr::filter(grepl("0/0", son))  
F0_0.1F1son_0.1 <- F0_0.1 %>%
  dplyr::filter(grepl("0/1", son))
F0_0.1F1son_1.1 <- F0_0.1 %>%
  dplyr::filter(grepl("1/1", son))

# now we make a table that count the sites in each option
son <- data_frame(
  family = str_extract(sample, "[^_]+"),
  gt_F0 = "0/0"
)




count(gt_info, 'generation') 
CrossTable(gt_info$generation, gt_info$fam, prop.t=TRUE, prop.r=TRUE, prop.c=TRUE)

gt_F0 <- gt_info %>%
  dplyr::filter(grepl("240", fam)) %>%
  select(generation = "F0")

  dplyr::filter(grepl("0/0", fnd))
  
 gt_F0$generation 
  dplyr::filter(grepl("fnd", sample)) %>%
    
    
# make a frequency table for F0 and F1 offspring, for each of the genotypes.
  
  gt_F0_F1 <- gt_info %>%
  filter(generation %in% c("F1", "F0")) %>%

CrossTable(gt_info$generation, gt_info$ prop.t=TRUE, prop.r=TRUE, prop.c=TRUE)
  #prop.table(addmargins(xtabs(~fam + generation, data=gt_info)))
    
freq_F1 <- data.frame(
  family = gt_F0_F1$fam) %>%
  gtF0 = c("0/0","0/1","1/1") %>%
  F1 = c("son","dat","sis") %>%
  gtF1 = c("0/0","0/1","1/1") %>%
  mutate()  
)

class(gt_info)

#i exclude NAs as they are similar percentage across genotypes
df <- gt %>%
  select(c("site","family","fnd", "son","dat", "grnson", "grndat", "grndat")) %>%
  na.omit()

# plot 
pF1_son <- ggplot(df, aes(x=fnd, fill=son)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F0 mother genotype") + 
  ylab("Proportion of F1_son genotype") +
  labs(title = paste("F1_son genotype, family",df$family[1],""))





x <- select(gt_info, sample, sex)
gt_info$generation

# 6/2/2022
#continue from here --> 
# finalize the table that i need for making the big plots

class(gt_info)
#play:
mydf <- data.frame(A = c("498_499c_grndat_S180", "48_48_fnd_S20","502_503f_grn_S190", "534_535_3a_grnson_S144", "548_548a_son_S146","548_548a_sis_S146"), M1 = c(1:6), M2 = c(31:36), M3 = c(41:46))
x <- mydf %>%
  mutate(family = str_extract(A, "[^_]+")) %>%
  mutate(sex = case_when(
    grepl("son", A) ~ "male",
    grepl( "dat|fnd|sis", A) ~ "female",
    grepl( "_grn_",A) ~ "NI"
    ))

```

load each family separately:
## family 46
one grandat
```{r}
vcf_46 <- read.vcfR("/Users/nuriteliash/Documents/GitHub/linkage-map-BIGdata/vcf_fam/46_fam.Q40BIALLDP16HDP40mis.5Chr7.recode.vcf", verbose = FALSE )
vcf_46

# extract the genotype per site, for each of the samples:
gt_46 <- extract.gt(vcf_46, element = "GT") %>% as.data.frame() %>%
  rownames_to_column("site")
gt_46 <- gt_46 %>%
  mutate(family = str_extract(colnames(gt_46[2]), "[^_]+"))
  
# change the sample name to a general name:
colnames(gt_46)[grepl('fnd',colnames(gt_46))] <- 'fnd'
colnames(gt_46)[grepl('_son_',colnames(gt_46))] <- 'son'
colnames(gt_46)[grepl('_grnson',colnames(gt_46))] <- 'grnson'
colnames(gt_46)[grepl('_dat',colnames(gt_46))] <- 'dat'
colnames(gt_46)[grepl('_sis',colnames(gt_46))] <- 'sis'
colnames(gt_46)[grepl('grndat',colnames(gt_46))] <- 'grndat'
#colnames(gt)[grepl('a_grndat',colnames(gt))] <- 'grndat_a'
#colnames(gt)[grepl('b_grndat',colnames(gt))] <- 'grndat_b'


#i exclude NAs as they are similar percentage across genotypes
df_46 <- gt_46 %>%
  select(c("site","family","fnd", "son","dat", "grnson", "grndat", "grndat")) %>% na.omit()

# plot 
pF1_son <- ggplot(df_46, aes(x=fnd, fill=son)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F0 mother genotype") + 
  ylab("Proportion of F1_son genotype") +
  labs(title = paste("F1_son genotype, family",df_46$family[1],""))

pF1_dat <- ggplot(df, aes(x=fnd, fill=dat)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F0 mother genotype") + 
  ylab("Proportion of F1_daughter genotype") +
  labs(title = paste("F1_Daughter genotype, family",df$family[1],""))

pF2_grnson <- ggplot(df, aes(x=dat, fill=grnson)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F1_Daughter genotype") + 
  ylab("Proportion of F2_Grandson genotype") +
  labs(title = paste("F2_Grandson genotype, family",df$family[1],""))

pF2_grndat <- ggplot(df, aes(x=dat, fill=grndat)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F1_Daughter genotype") + 
  ylab("Proportion of F2_Granddaughter genotype") +
  labs(title = paste("F2_Granddaughter genotype, family",df$family[1],""))

ggarrange(pF1_son, pF1_dat,pF2_grnson, pF2_grndat,
          ncol = 3, nrow = 2)
```
## family 240
```{r}
vcf <- read.vcfR("/Users/nuriteliash/Documents/GitHub/linkage-map-BIGdata/240_fam.Q40BIALLDP16HDP40mis.5Chr7.recode.vcf", verbose = FALSE )
vcf

# extract the genotype per site, for each of the samples:
gt <- extract.gt(vcf, element = "GT") %>% as.data.frame() %>%
  rownames_to_column("site") %>%
mutate(family = str_extract(colnames(gt[2]), "[^_]+"))
  
# change the sample name to a general name:
colnames(gt)[grepl('fnd',colnames(gt))] <- 'fnd'
colnames(gt)[grepl('_son_',colnames(gt))] <- 'son'
colnames(gt)[grepl('_grnson',colnames(gt))] <- 'grnson'
colnames(gt)[grepl('_dat',colnames(gt))] <- 'dat'
colnames(gt)[grepl('_sis',colnames(gt))] <- 'sis'
#colnames(gt)[grepl('grndat',colnames(gt))] <- 'grndat'

#i exclude NAs as they are similar percentage across genotypes
df <- gt %>%
  select(c("site","family","fnd", "son","dat", "grnson")) %>%
  na.omit()

# plot son distribution
Pson <-ggplot(df, aes(x=fnd, fill=son)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("Foundres mother genotype") + 
  ylab("Proportion of son genotype") +
  labs(title = paste("Son genotype, family",df$family[1],""))

# plot daughter distribution
Pdat <- ggplot(df, aes(x=fnd, fill=dat)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("Foundres mother genotype") + 
  ylab("Proportion of daughter genotype") +
  labs(title = paste("Daughter genotype, family",df$family[1],""))

# do the same but this time for dat and grnson
Pgrnson <- ggplot(df, aes(x=dat, fill=grnson)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("Daughter genotype") + 
  ylab("Proportion of grandson genotype") +
  labs(title = paste("Grandson genotype, family",df$family[1],""))

grid.arrange(Pson, Pdat, Pgrnson, nrow = 1)
```

## family 43 
no sister
```{r}
vcf <- read.vcfR("/Users/nuriteliash/Documents/GitHub/linkage-map-BIGdata/vcf_fam/43_fam.Q40BIALLDP16HDP40mis.5Chr7.recode.vcf", verbose = FALSE )
vcf

# extract the genotype per site, for each of the samples:
gt <- extract.gt(vcf, element = "GT") %>% as.data.frame() %>%
  rownames_to_column("site")
gt <- gt %>%
  mutate(family = str_extract(colnames(gt[2]), "[^_]+"))
  
# change the sample name to a general name:
colnames(gt)[grepl('fnd',colnames(gt))] <- 'fnd'
colnames(gt)[grepl('_son_',colnames(gt))] <- 'son'
colnames(gt)[grepl('_grnson',colnames(gt))] <- 'grnson'
colnames(gt)[grepl('_dat',colnames(gt))] <- 'dat'
#colnames(gt)[grepl('_sis',colnames(gt))] <- 'sis'
colnames(gt)[grepl('grndat',colnames(gt))] <- 'grndat'

#i exclude NAs as they are similar percentage across genotypes
df <- gt %>%
  select(c("site","family","fnd", "son","dat", "grnson", "grndat")) %>%
  na.omit()

# plot 
pF1_son <- ggplot(df, aes(x=fnd, fill=son)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F0 mother genotype") + 
  ylab("Proportion of F1_son genotype") +
  labs(title = paste("F1_son genotype, family",df$family[1],""))

pF1_dat <- ggplot(df, aes(x=fnd, fill=dat)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F0 mother genotype") + 
  ylab("Proportion of F1_daughter genotype") +
  labs(title = paste("F1_Daughter genotype, family",df$family[1],""))

pF2_grnson <- ggplot(df, aes(x=dat, fill=grnson)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F1_Daughter genotype") + 
  ylab("Proportion of F2_Grandson genotype") +
  labs(title = paste("F2_Grandson genotype, family",df$family[1],""))

pF2_grndat <- ggplot(df, aes(x=dat, fill=grndat)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F1_Daughter genotype") + 
  ylab("Proportion of F2_Granddaughter genotype") +
  labs(title = paste("F2_Granddaughter genotype, family",df$family[1],""))

ggarrange(pF1_son, pF1_dat,pF2_grnson, pF2_grndat,
          ncol = 2, nrow = 2)
```

## family 177 
no sister
```{r}
vcf <- read.vcfR("/Users/nuriteliash/Documents/GitHub/linkage-map-BIGdata/vcf_fam/177_fam.Q40BIALLDP16HDP40mis.5Chr7.recode.vcf", verbose = FALSE )
vcf

# extract the genotype per site, for each of the samples:
gt <- extract.gt(vcf, element = "GT") %>% as.data.frame() %>%
  rownames_to_column("site")
gt <- gt %>%
  mutate(family = str_extract(colnames(gt[2]), "[^_]+"))
  
# change the sample name to a general name:
colnames(gt)[grepl('fnd',colnames(gt))] <- 'fnd'
colnames(gt)[grepl('_son_',colnames(gt))] <- 'son'
colnames(gt)[grepl('_grnson',colnames(gt))] <- 'grnson'
colnames(gt)[grepl('_dat',colnames(gt))] <- 'dat'
colnames(gt)[grepl('_sis',colnames(gt))] <- 'sis'
colnames(gt)[grepl('grndat',colnames(gt))] <- 'grndat'

#i exclude NAs as they are similar percentage across genotypes
df <- gt %>%
  select(c("site","family","fnd", "son","dat", "grnson", "grndat")) %>%
  na.omit()

# plot 
pF1_son <- ggplot(df, aes(x=fnd, fill=son)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F0 mother genotype") + 
  ylab("Proportion of F1_son genotype") +
  labs(title = paste("F1_son genotype, family",df$family[1],""))

pF1_dat <- ggplot(df, aes(x=fnd, fill=dat)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F0 mother genotype") + 
  ylab("Proportion of F1_daughter genotype") +
  labs(title = paste("F1_Daughter genotype, family",df$family[1],""))

pF2_grnson <- ggplot(df, aes(x=dat, fill=grnson)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F1_Daughter genotype") + 
  ylab("Proportion of F2_Grandson genotype") +
  labs(title = paste("F2_Grandson genotype, family",df$family[1],""))

pF2_grndat <- ggplot(df, aes(x=dat, fill=grndat)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F1_Daughter genotype") + 
  ylab("Proportion of F2_Granddaughter genotype") +
  labs(title = paste("F2_Granddaughter genotype, family",df$family[1],""))

ggarrange(pF1_son, pF1_dat,pF2_grnson, pF2_grndat,
          ncol = 2, nrow = 2)
```

## family 110
no sister
```{r}
vcf <- read.vcfR("/Users/nuriteliash/Documents/GitHub/linkage-map-BIGdata/vcf_fam/110_fam.Q40BIALLDP16HDP40mis.5Chr7.recode.vcf", verbose = FALSE )
vcf

# extract the genotype per site, for each of the samples:
gt <- extract.gt(vcf, element = "GT") %>% as.data.frame() %>%
  rownames_to_column("site")
gt <- gt %>%
  mutate(family = str_extract(colnames(gt[2]), "[^_]+"))
  
# change the sample name to a general name:
colnames(gt)[grepl('fnd',colnames(gt))] <- 'fnd'
colnames(gt)[grepl('_son_',colnames(gt))] <- 'son'
colnames(gt)[grepl('_grnson',colnames(gt))] <- 'grnson'
colnames(gt)[grepl('_dat',colnames(gt))] <- 'dat'
colnames(gt)[grepl('grndat',colnames(gt))] <- 'grndat'

#i exclude NAs as they are similar percentage across genotypes
df <- gt %>%
  select(c("site","family","fnd", "son","dat", "grnson", "grndat")) %>%
  na.omit()

# plot 
pF1_son <- ggplot(df, aes(x=fnd, fill=son)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F0 mother genotype") + 
  ylab("Proportion of F1_son genotype") +
  labs(title = paste("F1_son genotype, family",df$family[1],""))

pF1_dat <- ggplot(df, aes(x=fnd, fill=dat)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F0 mother genotype") + 
  ylab("Proportion of F1_daughter genotype") +
  labs(title = paste("F1_Daughter genotype, family",df$family[1],""))

pF2_grnson <- ggplot(df, aes(x=dat, fill=grnson)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F1_Daughter genotype") + 
  ylab("Proportion of F2_Grandson genotype") +
  labs(title = paste("F2_Grandson genotype, family",df$family[1],""))

pF2_grndat <- ggplot(df, aes(x=dat, fill=grndat)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F1_Daughter genotype") + 
  ylab("Proportion of F2_Granddaughter genotype") +
  labs(title = paste("F2_Granddaughter genotype, family",df$family[1],""))

ggarrange(pF1_son, pF1_dat,pF2_grnson, pF2_grndat,
          ncol = 2, nrow = 2)
```

```{r}
vcf <- read.vcfR("/Users/nuriteliash/Documents/GitHub/linkage-map-BIGdata/vcf_fam/240_fam.Q40BIALLDP16HDP40mis.5Chr7.recode.vcf", verbose = FALSE )
vcf

# extract the genotype per site, for each of the samples:
gt <- extract.gt(vcf, element = "GT") %>% as.data.frame() %>%
  rownames_to_column("site")
gt <- gt %>%
  mutate(family = str_extract(colnames(gt[2]), "[^_]+"))
  
# change the sample name to a general name:
colnames(gt)[grepl('fnd',colnames(gt))] <- 'fnd'
colnames(gt)[grepl('_son_',colnames(gt))] <- 'son'
colnames(gt)[grepl('_grnson',colnames(gt))] <- 'grnson'
colnames(gt)[grepl('_dat',colnames(gt))] <- 'dat'
colnames(gt)[grepl('_sis',colnames(gt))] <- 'sis'
colnames(gt)[grepl('a_grndat',colnames(gt))] <- 'grndat_a'
colnames(gt)[grepl('b_grndat',colnames(gt))] <- 'grndat_b'


#i exclude NAs as they are similar percentage across genotypes
df <- gt %>%
  select(c("site","family","fnd", "son","dat", "grnson", "grndat_a", "grndat_b")) %>%
  na.omit()

# plot 
pF1_son <- ggplot(df, aes(x=fnd, fill=son)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F0 mother genotype") + 
  ylab("Proportion of F1_son genotype") +
  labs(title = paste("F1_son genotype, family",df$family[1],""))

pF1_dat <- ggplot(df, aes(x=fnd, fill=dat)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F0 mother genotype") + 
  ylab("Proportion of F1_daughter genotype") +
  labs(title = paste("F1_Daughter genotype, family",df$family[1],""))

pF1_sis <- ggplot(df, aes(x=fnd, fill=sis)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F0 mother genotype") + 
  ylab("Proportion of F1_sister genotype") +
  labs(title = paste("F1_sister genotype, family",df$family[1],""))

pF2_grnson <- ggplot(df, aes(x=dat, fill=grnson)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F1_Daughter genotype") + 
  ylab("Proportion of F2_Grandson genotype") +
  labs(title = paste("F2_Grandson genotype, family",df$family[1],""))

pF2_grndat <- ggplot(df, aes(x=dat, fill=grndat)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent) +
  xlab("F1_Daughter genotype") + 
  ylab("Proportion of F2_Granddaughter genotype") +
  labs(title = paste("F2_Granddaughter genotype, family",df$family[1],""))

ggarrange(pF1_son, pF1_dat, pF1_sis,pF2_grnson, pF2_grndat,
          ncol = 3, nrow = 2)
```

if you want to extract the sites:
```{r eval=FALSE, include=FALSE}
# (1) extract the sites that are homozygotic 0/0 in the founders mite
homoRef_fnd <- gt %>%
  dplyr::filter(grepl("0/0", fnd))

# (2) extract the sites that are homozygotic 1/1 in the founders mite
homoAlt_fnd <- gt %>%
  dplyr::filter(grepl("1/1", fnd))

# (3) extract the sites that are hetero 0/1 in the founders mite
hetero_fnd <- gt %>%
  dplyr::filter(grepl("0/1", fnd))


# how many of the son's sites are homozygotic as the mom (0/0)? --> expected from haplo-diplo inheritance mode
homoRef_son_homRef_fnd <- homoRef_fnd %>%
  dplyr::filter(grepl("0/0", son))  
# how many of the sites are heterozygotic? 0/1--> expected from diplo inheritance mode
hetero_son_homRef_fnd <- homoRef_fnd %>%
  dplyr::filter(grepl("0/1", son))
# how many of the sites are homozygotic 1/1? --> impossible (mistake) 
homoAlt_son_homRef_fnd <- homoRef_fnd %>%
  dplyr::filter(grepl("1/1", son))

```




didnt use:
filtered_177 <- read.table("/Users/nuriteliash/Documents/GitHub/linkage-map-BIGdata/177_fam.Q40BIALLDP16HDP40mis.5Chr7.recode.vcf",
  colClasses = c("CHR","POS", "177_178c_grn", "177_177a_son", "177_178_dat", "177_178d_grn", "177_178b_grnson", "177_177_fnd", "177_178a_grndat"),  header = TRUE)

for facet:
```{r cars}
# library & datset
library(ggplot2)
head(mtcars)
 
# Split by columns (default)
ggplot( mtcars , aes(x=mpg, y=wt, color=as.factor(cyl) )) + 
  geom_point(size=3) +  
  facet_wrap(~cyl) +
  theme(legend.position="none")
# Split by row
ggplot( mtcars , aes(x=mpg, y=wt, color=as.factor(cyl)  )) + 
  geom_point(size=3) +  
  facet_wrap(~cyl , dir="v")  +
  theme(legend.position="none")
# Add label at the bottom
ggplot( mtcars , aes(x=mpg, y=wt, color=as.factor(cyl)  )) + 
  geom_point(size=3) +  
  facet_wrap(~cyl , strip.position="bottom") +
  theme(legend.position="none")
# Use same scales for all
ggplot( mtcars , aes(x=mpg, y=wt, color=as.factor(cyl)  )) + 
  geom_point(size=3) +  
  facet_wrap(~cyl , scales="free" ) +
  theme(legend.position="none")```

## Including Plots

You can also embed plots, for example:

```
