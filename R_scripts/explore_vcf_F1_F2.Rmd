---
title: "explore_vcf_F1_F2"
author: "Nurit Eliash"
date: "1/24/2022"
output:
  html_document:
    code_folding: hide
    theme: cerulean
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: yes
      df_print: paged
---
<style type="text/css">
  body{
  font-size: 12pt;
}
</style>


## Varroa mode of inheritance (from F1 to F2)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### load libraries
```{r}
library("tidyverse")
library("plyr")
library("dplyr")
library("ggplot2")
library("scales")
library("ggpubr")
library("gridExtra")
library("grid")
library("GGally")
library("vcfR") # for extracting genotype data from a vcf file
library("data.table")
library("stringr")
library("janitor")
library("gmodels")
library("rstatix")
library("freqtables")
#library("fuzzyjoin") # to join tables based on a string in a column
library("broom")
# library("aspi") # Repeated G–tests of Goodness-of-Fit, work only for 2 variables... 
library("DescTools") # for the Goodness-of-Fit test, 3 variables; and for Breslow-Day Test for Homogeneity of the Odds Ratios
library("vcd") # for the woolf test testign log odds for each pair
#library("RVAideMemoire") # Repeated G–tests of Goodness-of-Fit, work only for 2 variables...
#library("InfoTrad")
#library("ggthemes") # for more colors in the ggplot
```

### Load vcf file and extract genotypes
```{r}
vcf <- read.vcfR("/Users/nuriteliash/Documents/GitHub/varroa-linkage-map/data/vcf_filter/Q40BIALLDP16HDP40mis.5Chr7/Q40BIALLDP16HDP40mis.5Chr7.recode.vcf", verbose = FALSE )
vcf
# extract the genotype for each site in each individual
gt <- extract.gt(vcf, element = "GT") 
gt <- as.data.frame(t(gt)) %>%
  rownames_to_column("ID")
#clean the ID names
gt$ID <- sub("_[^_]+$", "", gt$ID)

table <-  gt %>% 
  t() %>%
  as.data.frame() %>%
  row_to_names(row_number = 1) %>%
  dplyr::select(contains(c("son", "dat"))) # keep only adults of F1 and F2 
```

## F1 male (0/0) x female (0/1)
### Prepare table with observed and expected counts, per family
```{r}
# set the families (include only families with at least one adult F2)
family = grep("grndat|grnson",gt$ID, value=TRUE) %>%
  str_extract("[^_]+")  %>%
  unique()

# define a list to put all the data frames in
obs <- list()

for (fam in family) {
 
obs[[fam]] <- table %>%
  dplyr::select(starts_with(fam)) %>%
  dplyr::filter_at(vars(matches("_son")), all_vars(. == "0/0")) %>%
  dplyr::filter_at(vars(matches("_dat")), all_vars(. == "0/1")) %>% 
  dplyr::select(contains("grn")) %>%
  tidyr::pivot_longer(everything())  %>% 
  dplyr::rename(sample = name, gt = value) %>%
  dplyr::count(sample, gt, .drop = FALSE) %>% 
  dplyr::filter(gt %in% c("0/0", "1/1", "0/1")) %>%
  mutate(n = as.numeric(n)) %>%
  group_by(sample) %>%
  mutate(total = as.numeric(sum(n))) %>%
  dplyr::rename(obs = n) %>%
  mutate(sex = case_when(
    grepl("son", sample) ~ "male",
    grepl("dat", sample) ~ "female"))
}

# bind all families together, to a final data frame containing all observed counts
observed <- do.call("rbind", obs)

# state the expected site proportion of each genotype and sex under a perfect mendelian segregation of F2
fem_exp <- data.frame(sex = "female", gt = c("0/0", "0/1", "1/1") , prop = c(0.5, 0.5,0))
male_exp <- data.frame(sex = "male",gt = c("0/0", "0/1", "1/1"),prop = c(0.5, 0,0.5))
mendel <- bind_rows(fem_exp,male_exp) %>% mutate(sex = as.character(sex))%>% mutate(gt = as.character(gt)) 
 # mutate(type = "exp")

# using on the total genotypes count of sites per sample, calculate the expected counts, and add them to the observed counts into a final dat table
dat <- observed %>%
  #mutate(sample = as.character(sample)) %>%
  mutate(gt = as.character(gt)) %>%
  left_join(mendel, multi_by = c("sex")) %>% 
  mutate(exp = total*prop)
```

### bar plot, F1 male (0/0) x female (0/1)
```{r}
x <- dat %>%
  dplyr::select(c("sample","gt","sex", "exp","prop", "total")) %>%
  mutate(type = "exp") %>%
  dplyr::rename(count = exp)

y <- dat %>%
  dplyr::select(c("sample","gt","sex", "obs","total")) %>%
  mutate(type = "obs") %>%
  dplyr::rename(count = obs) %>%
  mutate(prop = (count/total))
  
df_male <- rbind(x, y) %>%
  dplyr::filter(sex == "male")
      
df_fem <- rbind(x, y) %>%
  dplyr::filter(sex == "female")

p_male <- ggplot(df_male, aes(fill=gt, y=prop, x=type)) + 
    geom_bar(position="fill", stat="identity", ) +
    xlab("F2 siblings") + 
    ylab("Proportion of F2 genotype") +
    labs(title = "F2 Males of F1 male (0/0) x female (0/1)") + 
   # geom_text(aes(label = n), position = position_stack(vjust = 0.5)) +
    geom_text(data = filter(df_male, gt == "0/0"), aes(y=prop, x=type, label=total), vjust = 0) +
    facet_wrap(~ sample) +
  labs(fill = "Genotype") +
  theme_classic()

p_female <- ggplot(df_fem, aes(fill=gt, y=prop, x=type)) + 
    geom_bar(position="fill", stat="identity", ) +
    xlab("F2 siblings") + 
    ylab("Proportion of F2 genotype") +
    labs(title = "F2 Females of F1 male (0/0) x female (0/1)") + 
   # geom_text(aes(label = n), position = position_stack(vjust = 0.5)) +
    geom_text(data = filter(df_fem, gt == "0/0"), aes(y=prop, x=type, label=total), vjust = 0) +
    facet_wrap(~ sample) +
  labs(fill = "Genotype") +
  theme_classic()

p_male_pooled <- ggplot(df_male, aes(fill=gt, y=prop, x=type)) + 
    geom_bar(position="fill", stat="identity", ) +
    xlab("F2 males") + 
    ylab("Proportion of F2 genotype") +
    labs(title = "F2 Males of F1 male (0/0) x female (0/1)", 
         subtitle = paste0("Pooled sites = ", df_male %>% dplyr::filter(gt == "0/0") %>% dplyr::filter(type == "obs") %>% summarise(sum(total)) %>% as.numeric())) + 
  labs(fill = "Genotype") + theme_classic()

p_female_pooled <- ggplot(df_fem, aes(fill=gt, y=prop, x=type)) + 
    geom_bar(position="fill", stat="identity", ) +
    xlab("F2 females") + 
    ylab("Proportion of F2 genotype") +
    labs(title = "F2 females of F1 male (0/0) x female (0/1)", 
         subtitle = paste0("Pooled sites = ", df_fem %>% dplyr::filter(gt == "0/0") %>% dplyr::filter(type == "obs") %>% summarise(sum(total)) %>% as.numeric())) + 
  labs(fill = "Genotype") + theme_classic()

grid.arrange(p_female_pooled, p_male_pooled, ncol = 2)
```

## F1 male (0/1) x female (0/1)
### Prepare table with observed and expected counts, per family
```{r}
# set the families (include only families with at least one adult F2)
family = grep("grndat|grnson",gt$ID, value=TRUE) %>%
  str_extract("[^_]+")  %>%
  unique()

# define a list to put all the data frames in
obs <- list()

for (fam in family) {
 
obs[[fam]] <- table %>%
  dplyr::select(starts_with(fam)) %>%
  dplyr::filter_at(vars(matches("_son")), all_vars(. == "0/1")) %>%
  dplyr::filter_at(vars(matches("_dat")), all_vars(. == "0/1")) %>% 
  dplyr::select(contains("grn")) %>%
  tidyr::pivot_longer(everything())  %>% 
  dplyr::rename(sample = name, gt = value) %>%
  dplyr::count(sample, gt, .drop = FALSE) %>% 
  dplyr::filter(gt %in% c("0/0", "1/1", "0/1")) %>%
  mutate(n = as.numeric(n)) %>%
  group_by(sample) %>%
  mutate(total = as.numeric(sum(n))) %>%
  dplyr::rename(obs = n) %>%
  mutate(sex = case_when(
    grepl("son", sample) ~ "male",
    grepl("dat", sample) ~ "female"))
}

# bind all families together, to a final data frame containing all observed counts
observed <- do.call("rbind", obs)

# state the expected site proportion of each genotype and sex under a perfect mendelian segregation of F2
fem_exp <- data.frame(sex = "female", gt = c("0/0", "0/1", "1/1") , prop = c(0.25, 0.5,0.25))
male_exp <- data.frame(sex = "male",gt = c("0/0", "0/1", "1/1"),prop = c(0.5, 0,0.5))
mendel <- bind_rows(fem_exp,male_exp) %>% mutate(sex = as.character(sex))%>% mutate(gt = as.character(gt)) 
 # mutate(type = "exp")

# using on the total genotypes count of sites per sample, calculate the expected counts, and add them to the observed counts into a final dat table
dat <- observed %>%
  #mutate(sample = as.character(sample)) %>%
  mutate(gt = as.character(gt)) %>%
  left_join(mendel, multi_by = c("sex")) %>% 
  mutate(exp = total*prop)
```

### bar plot, F1 male (0/1) x female (0/1)
```{r}
x <- dat %>%
  dplyr::select(c("sample","gt","sex", "exp","prop", "total")) %>%
  mutate(type = "exp") %>%
  dplyr::rename(count = exp)

y <- dat %>%
  dplyr::select(c("sample","gt","sex", "obs","total")) %>%
  mutate(type = "obs") %>%
  dplyr::rename(count = obs) %>%
  mutate(prop = (count/total))
  
df_male <- rbind(x, y) %>%
  dplyr::filter(sex == "male")
pool_count_male <- left_join(aggregate(count ~ gt, filter(df_male,type=="obs"), sum), 
                            aggregate(count ~ gt, filter(df_male,type=="exp"), sum), by ="gt") %>%
  rename(c(count.x = "obs", count.y = "exp"))
  
df_fem <- rbind(x, y) %>%
  dplyr::filter(sex == "female")

pool_count_female <- left_join(aggregate(count ~ gt, filter(df_fem,type=="obs"), sum), 
                            aggregate(count ~ gt, filter(df_fem,type=="exp"), sum), by ="gt") %>%
  rename(c(count.x = "obs", count.y = "exp"))

p_male <- ggplot(df_male, aes(fill=gt, y=prop, x=type)) + 
    geom_bar(position="fill", stat="identity", ) +
    xlab("F2 siblings") + 
    ylab("Proportion of F2 genotype") +
    labs(title = "F2 Males of F1 male (0/1) x female (0/1)") + 
   # geom_text(aes(label = n), position = position_stack(vjust = 0.5)) +
    geom_text(data = filter(df_male, gt == "0/1"), aes(y=prop, x=type, label=total), vjust = 0) +
    facet_wrap(~ sample) +
  labs(fill = "Genotype") +
  theme_classic()

p_female <- ggplot(df_fem, aes(fill=gt, y=prop, x=type)) + 
    geom_bar(position="fill", stat="identity", ) +
    xlab("F2 siblings") + 
    ylab("Proportion of F2 genotype") +
    labs(title = "F2 Females of F1 male (0/1) x female (0/1)") + 
   # geom_text(aes(label = n), position = position_stack(vjust = 0.5)) +
    geom_text(data = filter(df_fem, gt == "0/1"), aes(y=prop, x=type, label=total), vjust = 0) +
    facet_wrap(~ sample) +
  labs(fill = "Genotype") +
  theme_classic()

p_male_pooled <- ggplot(df_male, aes(fill=gt, y=prop, x=type)) + 
    geom_bar(position="fill", stat="identity") +
    xlab("F2 males") + 
    ylab("Proportion of F2 genotype") +
    labs(title = paste0("F2 Males, n sites = ", df_male %>% dplyr::filter(type == "obs") %>% summarise(sum(count)) %>% as.numeric()))  + 
  labs(fill = "Genotype") +
  scale_x_discrete("type", labels = c("Expected","Observed")) +
  theme(axis.title.x = element_blank()) + 
  theme_classic()

p_female_pooled <- ggplot(df_fem, aes(fill=gt, y=prop, x=type)) + 
    geom_bar(position="fill", stat="identity") +
    ylab("Proportion of F2 genotype") +
    labs(title = paste0("F2 Females, n sites = ", df_female %>% dplyr::filter(type == "obs") %>% summarise(sum(count)) %>% as.numeric())) + 
  labs(fill = "Genotype") +
  scale_x_discrete("type", labels = c("Expected","Observed")) +
  theme(axis.title.x = element_blank()) + 
  theme_classic()

grid.arrange(p_female_pooled, p_male_pooled, ncol = 2, top = textGrob("F2 genotypes of F1 male (0/1) x female (0/1) cross
pooled families",gp=gpar(fontsize=20)))
```





## Cochran–Mantel–Haenszel Test for Repeated Tests of Independence
### prepare the data frame 
```{r}
x <- dat %>%
  dplyr::select(c("sample","gt","sex", "exp","prop", "total")) %>%
  mutate(type = "exp") %>%
  dplyr::rename(count = exp)

y <- dat %>%
  dplyr::select(c("sample","gt","sex", "obs","total")) %>%
  mutate(type = "obs") %>%
  dplyr::rename(count = obs) %>%
  mutate(prop = (count/total))
```

### C-M-H Test for females 
```{r}
df <- rbind(x, y) %>%
  dplyr::filter(sex == "female") %>%
  dplyr::select(c("sample", "gt", "type", "count"))

### Specify the order of factor levels. Otherwise, R will alphabetize them
df =
mutate(df,
       sample = factor(sample, levels=unique(sample)),
       gt = factor(gt, levels=unique(gt)),
       type = factor(type, levels=unique(type))
       )
aggregate(count ~ gt, df, sum)

### Cross-tabulate the data
Data.xtabs = xtabs(count ~ type + gt + sample,
                   data=df)
ftable(Data.xtabs)   

# Cochran–Mantel–Haenszel test
CMH_fem <- mantelhaen.test(Data.xtabs)

# Woolf test for homogeneity of odds ratios across strata. If significant, C-M-H test is not appropriate
homogen_fem <- woolf_test(Data.xtabs)             
```

### C-M-H Test for males 
```{r}
df <- rbind(x, y) %>%
  dplyr::filter(sex == "male") %>%
  dplyr::select(c("sample", "gt", "type", "count"))

### Specify the order of factor levels. Otherwise, R will alphabetize them
df =
mutate(df,
       sample = factor(sample, levels=unique(sample)),
       gt = factor(gt, levels=unique(gt)),
       type = factor(type, levels=unique(type))
       )
aggregate(count ~ gt, df, sum)

### Cross-tabulate the data
Data.xtabs = xtabs(count ~ type + gt + sample,
                   data=df)
ftable(Data.xtabs)   

# Cochran–Mantel–Haenszel test
CMH_male <-mantelhaen.test(Data.xtabs)

# Woolf test for homogeneity of odds ratios across strata. If significant, C-M-H test is not appropriate
homogen_male <- woolf_test(Data.xtabs)             
```

## Replicated G-test of goodness of fit
### prepare table for G-test
```{r}
# make a table of observed counts for each genotype, per F2 offspring, for 0/0x0/1 cross
obs <- gt_502 %>% 
  filter(F1_male == "0/0" & F1_fem_1 == "0/1") %>% 
  select(contains(c("F2_male" , "F2_fem"))) %>%
  pivot_longer(everything()) %>% 
  dplyr::rename(sample = name, gt = value) %>%
  dplyr::count(sample, gt, .drop = FALSE) %>% 
  dplyr::filter(gt %in% c("0/0", "1/1", "0/1")) %>%
  mutate(n = as.numeric(n)) %>%
  group_by(sample) %>%
  mutate(total = as.numeric(sum(n))) %>%
  dplyr::rename(obs = n) %>%
  mutate(sex = case_when(
    grepl("male", sample) ~ "male",
    grepl("fem", sample) ~ "female"))
#  mutate(type = "obs")

# state the expected site proportion of each genotype and sex under a perfect mendelian segregation of F2
fem_exp <- data.frame(sex = "female", gt = c("0/0", "0/1", "1/1") , prop = c(0.5, 0.5,0))
male_exp <- data.frame(sex = "male",gt = c("0/0", "0/1", "1/1"),prop = c(0.5, 0,0.5))
mendel <- bind_rows(fem_exp,male_exp) %>% mutate(sex = as.character(sex))%>% mutate(gt = as.character(gt)) 
 # mutate(type = "exp")

# using on the total genotypes count of sites per sample, calculate the expected counts, and add them to the observed counts into a final dat table
dat <- obs %>%
  #mutate(sample = as.character(sample)) %>%
  mutate(gt = as.character(gt)) %>%
  left_join(mendel, multi_by = c("sex")) %>% 
  mutate(exp = total*prop)

#### optional - observed counts with Confidence intervals
obs_CI <- obs %>%
  mutate(prop = obs/total) %>%
  mutate(se = (sqrt(prop * (1-prop)/obs))) %>% 
  mutate(lower = prop - (se*1.96)) %>% 
  mutate(upper = prop + (se*1.96))
```
### run the G-test
```{r}
# calculate values for each sample, and join into one table
G<-dat %>%
  dplyr::select(c("sample","obs", "exp")) %>%
  group_by(sample) %>%
  dplyr::summarize(G = GTest(as.data.frame(cur_data()))$statistic)
df<-dat %>%
  dplyr::select(c("sample","obs", "exp")) %>%
  group_by(sample) %>%
  dplyr::summarize(df=GTest(as.data.frame(cur_data()))$parameter)
p<-dat %>%
  dplyr::select(c("sample","obs", "exp")) %>%
  group_by(sample) %>%
  dplyr::summarize(pval = GTest(as.data.frame(cur_data()))$p.value)

# total G-value
total_female <- left_join(G, full_join(df, p), by = "sample") %>%
  dplyr::filter(grepl("fem", sample)) %>%
  adorn_totals("row") %>%
  dplyr::filter(sample =="Total")
# G = 1.580142, df = 4

# pooled --> sum up the obs and exp for each genotyep. then do a gtest . the df should be= 2 
pooled_female <- dat %>% 
    #ungroup() %>%
    dplyr::filter(grepl("fem", sample)) %>%
    dplyr::select(c("sample", "gt","obs", "exp")) %>%
    ddply("gt",numcolwise(sum)) %>%
    dplyr::select(c("obs", "exp")) %>%
    GTest()
# no significance difference between observed and expected based on the pooled results
# G = 1.5594, X-squared df = 2, p-value = 0.4585
pooled_male <- dat %>% 
    #ungroup() %>%
    dplyr::filter(grepl("male", sample)) %>%
    dplyr::select(c("sample", "gt","obs", "exp")) %>%
    ddply("gt",numcolwise(sum)) %>%
    dplyr::select(c("obs", "exp")) %>%
    GTest()
# calculate the heterogenity between experiments (between the 2 females), using the G values and d.f. of the pooled and total values
# heterogeneity significance between replicates: 
hetero_p <- pchisq((total_female$G - pooled_female$statistic),
       df=(total_female$df - pooled_female$parameter),
       lower.tail=FALSE)
hetero_p
#there is no significance heterogeneity between samples
#G = 0.0207495 , df = 2, pval = 0.9896789 
``` 
